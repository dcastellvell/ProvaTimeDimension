<html>

<head>
    <title>Leaflet TimeDimension</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.2/Control.FullScreen.min.css">
        <link rel="stylesheet" href="css/leaflet.timedimension.control.css" />
       
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script> -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
    <!-- Treballar en CANVAS millora el rendiment. És un métode per rasteritzar les geometries -->
    <!-- <script>
        L_PREFER_CANVAS = true; 
    </script> -->
    <script type="text/javascript" src="https://cdn.rawgit.com/tryone144/dateFormat/master/date.format.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.2/Control.FullScreen.min.js"></script>
    <script type="text/javascript" src="js/NonTiledLayer.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/nezasa/iso8601-js-period/master/iso8601.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.2/leaflet-omnivore.min.js"></script>
  

    <script type="text/javascript" src="js/leaflet.timedimension.js"></script>
    <script type="text/javascript" src="js/leaflet.timedimension.util.js"></script>
    <script type="text/javascript" src="js/leaflet.timedimension.layer.js"></script>
    <script type="text/javascript" src="js/leaflet.timedimension.layer.geojson.js"></script>
    <script type="text/javascript" src="js/leaflet.timedimension.player.js"></script>
    <script type="text/javascript" src="js/leaflet.timedimension.control.js"></script>
    <!-- <script type="text/javascript" src="js/leaflet-omnivore.min.js"></script> -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>
        var startDate = new Date();
        startDate.setUTCHours(0, 0, 0, 0);

        var map = L.map('map', {
            zoom: 12,
            fullscreenControl: true,
            center: [39.3, 4]
        });

         var esri = L.tileLayer(
                'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 17,
                    minZoom: 1,
                    attribution: 'Tiles © Esri',
                })

            var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                minZoom: 1,
                attribution: 'OSM'
            }).addTo(map);


            var baseLayers = {
                "Orto_esri": esri,
                "Mapa_osm": osm
            };

        // start of TimeDimension manual instantiation
        var timeDimension = new L.TimeDimension({
            period: "PT5M",
        });
        // helper to share the timeDimension object between all layers
        map.timeDimension = timeDimension;
        // otherwise you have to set the 'timeDimension' option on all layers.

        var player = new L.TimeDimension.Player({
            transitionTime: 100,
            loop: false,
            startOver: true
        }, timeDimension);

        var timeDimensionControlOptions = {
            player: player,
            timeDimension: timeDimension,
            position: 'bottomleft',
            autoPlay: true,
            minSpeed: 1,
            speedStep: 0.5,
            maxSpeed: 15,
            timeSliderDragUpdate: true
        };

        var timeDimensionControl = new L.Control.TimeDimension(timeDimensionControlOptions);
        map.addControl(timeDimensionControl);

        var icon = L.icon({
            iconUrl: 'img/running.png',
            iconSize: [22, 22],
            iconAnchor: [5, 25]
        });

        var customLayer = L.geoJson(null, {
            pointToLayer: function (feature, latLng) {
                if (feature.properties.hasOwnProperty('last')) {
                    return new L.Marker(latLng, {
                        icon: icon
                    });
                }
                return L.circleMarker(latLng);
            }
        });

        var gpxLayer = omnivore.gpx('data/running_mallorca.gpx', null, customLayer).on('ready', function () {
            map.fitBounds(gpxLayer.getBounds(), {
                paddingBottomRight: [40, 40]
            });
        });

        var gpxTimeLayer = L.timeDimension.layer.geoJson(gpxLayer, {
            updateTimeDimension: true,
            addlastPoint: true,
            waitForReady: true
        });

        var kmlLayer = omnivore.kml('data/easy_currents_track.kml');
        var kmlTimeLayer = L.timeDimension.layer.geoJson(kmlLayer, {
            updateTimeDimension: true,
            addlastPoint: true,
            waitForReady: true
        });


        var overlayMaps = {
            "GPX Layer": gpxTimeLayer,
            "KML Layer": kmlTimeLayer
        };
        var baseLayers = getCommonBaseLayers(map); // see baselayers.js
        L.control.layers(baseLayers, overlayMaps).addTo(map);
        gpxTimeLayer.addTo(map);
    
    </script>

</head>

            <body>
                <div id="map" style="height: 95%; width: 100%"></div>
            </body>

</html>